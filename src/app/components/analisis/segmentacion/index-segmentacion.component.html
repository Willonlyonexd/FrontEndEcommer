<mat-card class="mb-4">
  <!-- Sidebar (normalmente debe ir FUERA de mat-card en layout real, pero aquí respetamos tu estructura) -->
  <app-sidebar></app-sidebar>

  <mat-card-header>
    <mat-card-title>Resumen de Segmentación</mat-card-title>
  </mat-card-header>

  <mat-card-content>

    <p><strong>Última actualización:</strong> {{ lastUpdate | date:'short' }}    </p>
    <p><strong>Total de clientes:</strong> {{ totalClientes }}</p>

    <!-- Spinner global de carga -->
    <div *ngIf="cargandoGeneral" class="spinner-container">
      <mat-spinner diameter="60"></mat-spinner>
    </div>

    <!-- Pie Chart (se muestra solo cuando todo está cargado) -->
    <ngx-charts-pie-chart
      *ngIf="!cargandoGeneral"
      [results]="pieData"
      [legend]="true"
      [labels]="true"
      [doughnut]="true"
      [explodeSlices]="false"
      [animations]="true"
      [scheme]="colorScheme"
      [view]="[600, 300]">
    </ngx-charts-pie-chart>

  </mat-card-content>

  <mat-card-actions>
    <button mat-raised-button color="primary" (click)="recalcular()" [disabled]="!puedeReentrenar || cargandoGeneral">
      <mat-progress-spinner
        *ngIf="cargandoGeneral"
        diameter="20"
        mode="indeterminate"
        strokeWidth="3"
        style="margin-right: 8px;">
      </mat-progress-spinner>
      <span *ngIf="!cargandoGeneral">Recalcular Segmentación</span>
    </button>
    <p *ngIf="!puedeReentrenar && !cargandoGeneral" style="margin-top: 10px; color: #999;">
      ⚠️ No hay suficientes datos nuevos para recalcular la segmentación.
    </p>
  </mat-card-actions>
</mat-card>

<mat-card class="mt-4">
  <mat-card-header>
    <mat-card-title>Distribución por Cliente (Recencia vs Monetario)</mat-card-title>
  </mat-card-header>

  <mat-card-content>

    <!-- Spinner global de carga -->
    <div *ngIf="cargandoGeneral" class="spinner-container">
      <mat-spinner diameter="60"></mat-spinner>
    </div>

    <!-- Bubble Chart -->
    <ngx-charts-bubble-chart
      *ngIf="!cargandoGeneral"
      [results]="bubbleData"
      [xAxis]="true"
      [yAxis]="true"
      [legend]="true"
      [showXAxisLabel]="true"
      [showYAxisLabel]="true"
      [xAxisLabel]="'Recencia (escalado)'"
      [yAxisLabel]="'Monetario (escalado)'"
      [scheme]="colorScheme"
      [autoScale]="true"
      [animations]="true"
      [roundDomains]="true"
      [view]="[700, 400]">
    </ngx-charts-bubble-chart>

  </mat-card-content>
</mat-card>
